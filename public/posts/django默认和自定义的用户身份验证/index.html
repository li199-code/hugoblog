<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.119.0">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>django默认和自定义的用户身份验证 &middot; JasonLee</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="http://blog.jasonleehere.com/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="http://blog.jasonleehere.com/css/poole.css">
  <link type="text/css" rel="stylesheet" href="http://blog.jasonleehere.com/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="http://blog.jasonleehere.com/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://blog.jasonleehere.com/"><h1>JasonLee</h1></a>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="http://blog.jasonleehere.com/">Home</a> </li>
        
      </ul>
    </nav>

    <p>&copy; 2023. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>django默认和自定义的用户身份验证</h1>
  <time datetime=2023-05-10T09:16:20Z class="post-date">Wed, May 10, 2023</time>
  <h2 id="前言">前言</h2>
<p>在做项目时，身份验证是目前疑虑最多的地方：为什么这里要新建一个User模型？为什么要重写管理器？这篇文章通过查阅文档，尝试从最佳实践的角度给出答案。</p>
<h2 id="默认验证方式">默认验证方式</h2>
<p>模型 视图函数 表单</p>
<p>注册 登录 登出</p>
<h3 id="默认user模型">默认User模型</h3>
<p>默认User模型主要包含以下字段：username、password、email、first_name、last_name。也就是说，如果有别的字段的需求（比如用户头像），就要自定义用户模型。目前暂不涉及权限，等到后续项目中接触到了，再添加。</p>
<h3 id="视图函数">视图函数</h3>
<h4 id="注册">注册</h4>
<p>没有内置的注册视图，有内置的注册表单UserCreationForm。UserCreationForm的要求字段为用户名、邮箱和两次密码输入。</p>
<pre tabindex="0"><code># views.py
class SignUpView(FormView):
    template_name = &#39;core/signup.html&#39;
    form_class = forms.SignUpForm
    success_url = &#39;/login/&#39;

    def form_valid(self, form):
        form.save()
        return super().form_valid(form)

# forms.py
class SignUpForm(UserCreationForm):
    class Meta:
        model = User
        fields = [&#39;username&#39;, &#39;email&#39;, &#39;password1&#39;, &#39;password2&#39;]

    username = forms.CharField(widget=forms.TextInput(attrs={
        &#39;placeholder&#39;: &#39;Your username&#39;,
        &#39;class&#39;: &#39;w-full py-4 px-6 rounded-xl&#39;
    }))
    email = forms.CharField(widget=forms.EmailInput(attrs={
        &#39;placeholder&#39;: &#39;Your email address&#39;,
        &#39;class&#39;: &#39;w-full py-4 px-6 rounded-xl&#39;
    }))
    password1 = forms.CharField(widget=forms.PasswordInput(attrs={
        &#39;placeholder&#39;: &#39;Your password&#39;,
        &#39;class&#39;: &#39;w-full py-4 px-6 rounded-xl&#39;
    }))
    password2 = forms.CharField(widget=forms.PasswordInput(attrs={
        &#39;placeholder&#39;: &#39;Repeat password&#39;,
        &#39;class&#39;: &#39;w-full py-4 px-6 rounded-xl&#39;
    }))
</code></pre><h4 id="登录">登录</h4>
<p>有内置视图LoginView，有内置的表单AuthenticationForm</p>
<pre tabindex="0"><code># forms.py
class LogInForm(AuthenticationForm):
    username = forms.CharField(widget=forms.TextInput(attrs={
        &#39;placeholder&#39;: &#39;Your username&#39;,
        &#39;class&#39;: &#39;w-full py-4 px-6 rounded-xl&#39;
    }))
    password = forms.CharField(widget=forms.PasswordInput(attrs={
        &#39;placeholder&#39;: &#39;Your password&#39;,
        &#39;class&#39;: &#39;w-full py-4 px-6 rounded-xl&#39;
    }))

# urls.py
path(&#39;login/&#39;, auth_views.LoginView.as_view(template_name=&#39;core/login.html&#39;, authentication_form=LogInForm), name=&#39;login&#39;),

# settings.py
LOGIN_REDIRECT_URL = &#39;/&#39;
</code></pre><h4 id="登出">登出</h4>
<p>有内置视图LogoutView，无需视图</p>
<pre tabindex="0"><code># urls.py
path(&#39;logout/&#39;, auth_views.LogoutView.as_view(), name=&#39;logout&#39;)

# settings.py
LOGOUT_REDIRECT_URL = &#39;/&#39;
</code></pre><h2 id="自定义验证方式">自定义验证方式</h2>
<p>有两个可以自定义的地方：认证后端和User模型</p>
<h3 id="认证后端">认证后端</h3>
<p>前面提到的authenticate和login方法都是django默认认证后端提供的。</p>
<h3 id="user模型">User模型</h3>
<p>一般有两个需要扩展：模型本身和管理器（manager）</p>
<pre tabindex="0"><code># models.py

class CustomUserManager(UserManager):
    def _create_user(self, name, email, password, **extra_fields):
        if not email:
            raise ValueError(&#34;You have not provided a valid e-mail address&#34;)

        email = self.normalize_email(email)
        user = self.model(email=email, name=name, **extra_fields)
        user.set_password(password)
        user.save(using=self._db)

        return user

    def create_user(self, name=None, email=None, password=None, **extra_fields):
        extra_fields.setdefault(&#39;is_staff&#39;, False)
        extra_fields.setdefault(&#39;is_superuser&#39;, False)
        return self._create_user(name, email, password, **extra_fields)

    def create_superuser(self, name=None, email=None, password=None, **extra_fields):
        extra_fields.setdefault(&#39;is_staff&#39;, True)
        extra_fields.setdefault(&#39;is_superuser&#39;, True)
        return self._create_user(name, email, password, **extra_fields)


class User(AbstractBaseUser, PermissionsMixin):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    email = models.EmailField(unique=True)
    name = models.CharField(max_length=255, blank=True, default=&#39;&#39;)
    avatar = models.ImageField(upload_to=&#39;avatars&#39;, blank=True, null=True)

    is_active = models.BooleanField(default=True)
    is_superuser = models.BooleanField(default=False)
    is_staff = models.BooleanField(default=False)

    date_joined = models.DateTimeField(default=timezone.now)
    last_login = models.DateTimeField(blank=True, null=True)

    objects = CustomUserManager()

    USERNAME_FIELD = &#39;email&#39;
    EMAIL_FIELD = &#39;email&#39;
    REQUIRED_FIELDS = []
</code></pre>
</div>


    </main>

    
      
    
  </body>
</html>
